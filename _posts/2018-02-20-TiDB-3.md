---
title:  “TiDB源代码阅读第三篇”
mathjax: true
layout: post
date:   2018-02-20 08:00:12 +0800
categories: distributed system
---

一条SQL语句需要经过语法解析-->合法性验证-->制定查询计划-->优化查询计划-->根据计划生成查询器-->执行并返回结果
等一系列流程。下面尝试跟踪一下这个流程。首先将config/config.go中的日志级别调整为debug以便观察内部输出。
```go
var defaultConf = Config{
	Host:       "0.0.0.0",
	Port:       4000,
	Store:      "mocktikv",
	Path:       "/tmp/tidb",
	RunDDL:     true,
	Lease:      "10s",
	TokenLimit: 1000,
	Log: Log{
		Level:  "debug",
		Format: "text",
		File: logutil.FileLogConfig{
			LogRotate: true,
		},
		SlowThreshold:  300,
		QueryLogMaxLen: 2048,
	},
```


在TiDB启动过程中，会执行SELECT语句从mysql.user表里取出用户信息。
```sql
select Host,User,Password,Select_priv,Insert_priv,Update_priv,Delete_priv,Create_priv,
Drop_priv,Process_priv,Grant_priv,References_priv,Alter_priv,Show_db_priv,Super_priv,
Execute_priv,Index_priv,Create_user_priv,Trigger_priv from mysql.user order by host, user;
```

语法解析的代码在session.go里:
```go
func (s *session) Execute(sql string) (recordSets []ast.RecordSet, err error) {
	s.PrepareTxnCtx()
	......
		err = s.loadCommonGlobalVariablesIfNeeded()
		if err != nil {
			return nil, errors.Trace(err)
		}

		charset, collation := s.sessionVars.GetCharsetInfo()

		// Step1: Compile query string to abstract syntax trees(ASTs).
		startTS := time.Now()
		stmtNodes, err := s.ParseSQL(sql, charset, collation)
		if err != nil {
			log.Warnf("[%d] parse error:\n%v\n%s", connID, err, sql)
			return nil, errors.Trace(err)
		}
		sessionExecuteParseDuration.Observe(time.Since(startTS).Seconds())

		compiler := executor.Compiler{}
		for _, stmtNode := range stmtNodes {
			s.PrepareTxnCtx()
			......
		}
	}
}

func (s *session) ParseSQL(sql, charset, collation string) ([]ast.StmtNode, error) {
	s.parser.SetSQLMode(s.sessionVars.SQLMode)
	return s.parser.Parse(sql, charset, collation)
}
```

日志:
```bash
2018/02/23 10:38:08.617 domain.go:305: [info] [ddl] full load and reset schema validator.
2018/02/23 10:38:08.617 schema_validator.go:116: [debug] update schema validator, old ver 0, curr ver 13, changed IDs []
2018/02/23 10:38:08.617 session.go:713: [debug] session.go function Execute
2018/02/23 10:38:08.617 session.go:713: [debug] Execute sql: [select Host,User,Password,Select_priv,Insert_priv,Update_priv,Delete_priv,Create_priv,Drop_priv,Process_priv,Grant_priv,References_priv,Alter_priv,Show_db_priv,Super_priv,Execute_priv,Index_priv,Create_user_priv,Trigger_priv from mysql.user order by host, user;]
2018/02/23 10:38:08.617 session.go:713: [debug] session.go function Execute
2018/02/23 10:38:08.617 session.go:713: [debug] Execute sql: [select HIGH_PRIORITY * from mysql.global_variables where variable_name in ('autocommit', 'sql_mode', 'max_allowed_packet', 'time_zone', 'tidb_skip_utf8_check', 'tidb_index_join_batch_size', 'tidb_index_lookup_size', 'tidb_index_lookup_concurrency', 'tidb_index_serial_scan_concurrency', 'tidb_max_row_count_for_inlj', 'tidb_distsql_scan_concurrency')]
2018/02/23 10:38:08.617 session.go:756: [debug] session.go function ParseSQL
2018/02/23 10:38:08.617 session.go:667: [debug] s.sessVars.SQLMode: [0]
2018/02/23 10:38:08.617 session.go:688: [debug] session.go function executeStatement
2018/02/23 10:38:08.617 adapter.go:260: [debug] [0][ActivePendingTxn] select HIGH_PRIORITY * from mysql.global_variables where variable_name in ('autocommit', 'sql_mode', 'max_allowed_packet', 'time_zone', 'tidb_skip_utf8_check', 'tidb_index_join_batch_size', 'tidb_index_lookup_size', 'tidb_index_lookup_concurrency', 'tidb_index_serial_scan_concurrency', 'tidb_max_row_count_for_inlj', 'tidb_distsql_scan_concurrency')
2018/02/23 10:38:08.618 adapter.go:319: [debug] query connectionId=0 costTime=465.243µs database= sql=select HIGH_PRIORITY * from mysql.global_variables where variable_name in ('autocommit', 'sql_mode', 'max_allowed_packet', 'time_zone', 'tidb_skip_utf8_check', 'tidb_index_join_batch_size', 'tidb_index_lookup_size', 'tidb_index_lookup_concurrency', 'tidb_index_serial_scan_concurrency', 'tidb_max_row_count_for_inlj', 'tidb_distsql_scan_concurrency') type=query succ=true
2018/02/23 10:38:08.618 session.go:756: [debug] session.go function ParseSQL
2018/02/23 10:38:08.618 session.go:667: [debug] s.sessVars.SQLMode: [2151677952]
2018/02/23 10:38:08.618 session.go:688: [debug] session.go function executeStatement
2018/02/23 10:38:08.618 adapter.go:260: [debug] [0][ActivePendingTxn] select Host,User,Password,Select_priv,Insert_priv,Update_priv,Delete_priv,Create_priv,Drop_priv,Process_priv,Grant_priv,References_priv,Alter_priv,Show_db_priv,Super_priv,Execute_priv,Index_priv,Create_user_priv,Trigger_priv from mysql.user order by host, user;
2018/02/23 10:38:08.618 adapter.go:319: [debug] query database= sql=select Host,User,Password,Select_priv,Insert_priv,Update_priv,Delete_priv,Create_priv,Drop_priv,Process_priv,Grant_priv,References_priv,Alter_priv,Show_db_priv,Super_priv,Execute_priv,Index_priv,Create_user_priv,Trigger_priv from mysql.user order by host, user; type=query connectionId=0 costTime=237.663µs succ=true
```

**问题1**: 为什么`SELECT HIGH_PRIORITY *`的SQLMode是0， 而`SELECT Host,User,...`的
SQLMode是0x80400000 (STRICT_TRANS_TABLES | NO_ENGINE_SUBSTITUTION)?

# Parser

session结构体里包含一个指向Parser的指针; Parser结构体包含Scanner（实现yyLexer
接口）。Lex是一个词法分析器，比如`SELECT DB, Host FROM mysql`这个语句中，`SELECT`和`DB`都
被解析成数字类型57346（Identifier）, `,`被解析成数字类型44（逗号）。然后再由Yacc进行语法分析，
语法定义在parser/parser.y文件中，用于检查输入的SQL语句是否有语法错误，比如`SELECT DB; Host FROM mysql`
就显然是不合法的。

打个比方就是，Lex将一个英语句子中的单词标记为名词，动词，形容词等等；Yacc判断这个句子是否
符合英语语法，最简单的情况即是主语（名词） + 谓语（动词）。

感觉光是parser.y文件已经相当庞大了，不知道TiDB团队是从零开始，还是直接参考
了cockroachdb/cockroach/pkg/sql/parser的内容，毕竟SQL语法解析是通用的，
除了TiDBKeyword。

# 解析结果

ParseSQL返回结果是一个ast.StmtNode数组。
![image01]({{site.baseurl}}/image/stmt_class_diagram.png)

在上面的例子里面只有一个SelectStmt，JSON格式化如下:
```json
{
    "SQLCache":true,
    "CalcFoundRows":false,
    "Priority":0,
    "Distinct":false,
    "From":{
        "TableRefs":{
            "Left":{
                "Source":{
                    "Schema":{
                        "O":"mysql",
                        "L":"mysql"
                    },
                    "Name":{
                        "O":"user",
                        "L":"user"
                    },
                    "DBInfo":null,
                    "TableInfo":null,
                    "IndexHints":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                }
            },
            "Right":null,
            "Tp":0,
            "On":null,
            "Using":null,
            "NaturalJoin":false
        }
    },
    "Where":null,
    "Fields":{
        "Fields":[
            {
                "Offset":7,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Host",
                            "L":"host"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":12,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"User",
                            "L":"user"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":17,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Password",
                            "L":"password"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":26,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Select_priv",
                            "L":"select_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":38,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Insert_priv",
                            "L":"insert_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":50,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Update_priv",
                            "L":"update_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":62,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Delete_priv",
                            "L":"delete_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":74,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Create_priv",
                            "L":"create_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":86,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Drop_priv",
                            "L":"drop_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":96,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Process_priv",
                            "L":"process_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":109,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Grant_priv",
                            "L":"grant_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":120,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"References_priv",
                            "L":"references_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":136,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Alter_priv",
                            "L":"alter_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":147,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Show_db_priv",
                            "L":"show_db_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":160,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Super_priv",
                            "L":"super_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":171,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Execute_priv",
                            "L":"execute_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":184,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Index_priv",
                            "L":"index_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":195,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Create_user_priv",
                            "L":"create_user_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            },
            {
                "Offset":212,
                "WildCard":null,
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"Trigger_priv",
                            "L":"trigger_priv"
                        }
                    },
                    "Refer":null
                },
                "AsName":{
                    "O":"",
                    "L":""
                },
                "Auxiliary":false
            }
        ]
    },
    "GroupBy":null,
    "Having":null,
    "OrderBy":{
        "Items":[
            {
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"host",
                            "L":"host"
                        }
                    },
                    "Refer":null
                },
                "Desc":false
            },
            {
                "Expr":{
                    "Type":{
                        "Tp":0,
                        "Flag":0,
                        "Flen":0,
                        "Decimal":0,
                        "Charset":"",
                        "Collate":"",
                        "Elems":null
                    },
                    "Name":{
                        "Schema":{
                            "O":"",
                            "L":""
                        },
                        "Table":{
                            "O":"",
                            "L":""
                        },
                        "Name":{
                            "O":"user",
                            "L":"user"
                        }
                    },
                    "Refer":null
                },
                "Desc":false
            }
        ],
        "ForUnion":false
    },
    "Limit":null,
    "LockTp":0,
    "TableHints":null
}
```

AST语法树:  
![image02]({{site.baseurl}}/image/stmt_ast.png)
